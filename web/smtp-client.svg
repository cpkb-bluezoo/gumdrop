<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 900">
  <defs>
    <style>
      .state { fill: #e8f4f8; stroke: #2c5282; stroke-width: 2; }
      .state-ready { fill: #c6f6d5; stroke: #276749; stroke-width: 2; }
      .state-data { fill: #fef3c7; stroke: #92400e; stroke-width: 2; }
      .state-terminal { fill: #fed7d7; stroke: #c53030; stroke-width: 2; }
      .state-tls { fill: #e9d8fd; stroke: #6b46c1; stroke-width: 2; }
      .label { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 13px; fill: #1a202c; }
      .label-title { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 14px; font-weight: 600; fill: #1a202c; }
      .label-small { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 11px; fill: #4a5568; }
      .label-method { font-family: 'Consolas', 'Monaco', monospace; font-size: 11px; fill: #2d3748; }
      .arrow { fill: none; stroke: #4a5568; stroke-width: 1.5; }
      .arrow-success { fill: none; stroke: #276749; stroke-width: 1.5; }
      .arrow-fail { fill: none; stroke: #c53030; stroke-width: 1.5; stroke-dasharray: 4,2; }
      .arrow-head { fill: #4a5568; }
      .arrow-head-success { fill: #276749; }
      .interface-box { fill: #f7fafc; stroke: #a0aec0; stroke-width: 1; rx: 4; }
      .handler-box { fill: #fffaf0; stroke: #dd6b20; stroke-width: 1; rx: 4; }
      .title { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 20px; font-weight: 700; fill: #1a202c; }
      .subtitle { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 12px; fill: #718096; }
      .fatal-zone { fill: #fff5f5; stroke: #fc8181; stroke-width: 1; stroke-dasharray: 5,3; rx: 8; }
      .legend-box { fill: #ffffff; stroke: #e2e8f0; stroke-width: 1; rx: 4; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" class="arrow-head"/>
    </marker>
    <marker id="arrowhead-success" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" class="arrow-head-success"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1100" height="900" fill="#ffffff"/>
  
  <!-- Title -->
  <text x="550" y="35" text-anchor="middle" class="title">SMTP Client State Machine</text>
  <text x="550" y="55" text-anchor="middle" class="subtitle">Handler implements Server*ReplyHandler • Connection implements Client*State</text>

  <!-- Fatal Error Zone -->
  <rect x="720" y="75" width="360" height="90" class="fatal-zone"/>
  <text x="900" y="100" text-anchor="middle" class="label-title" fill="#c53030">Fatal: 421 Service Closing</text>
  <text x="900" y="118" text-anchor="middle" class="label-small">Can occur at ANY state</text>
  <text x="900" y="136" text-anchor="middle" class="label-method">→ handleServiceClosing(message)</text>
  <text x="900" y="152" text-anchor="middle" class="label-small">Connection closes automatically</text>

  <!-- Legend -->
  <rect x="20" y="75" width="200" height="100" class="legend-box"/>
  <text x="30" y="95" class="label-small" font-weight="600">Legend:</text>
  <rect x="30" y="105" width="16" height="12" class="state"/>
  <text x="52" y="115" class="label-small">Protocol State</text>
  <rect x="30" y="123" width="16" height="12" class="state-ready"/>
  <text x="52" y="133" class="label-small">Session Ready</text>
  <rect x="30" y="141" width="16" height="12" class="state-data"/>
  <text x="52" y="151" class="label-small">Data Transfer</text>
  <rect x="30" y="159" width="16" height="12" class="state-tls"/>
  <text x="52" y="169" class="label-small">TLS Upgrade</text>
  
  <rect x="120" y="105" width="16" height="12" class="interface-box"/>
  <text x="142" y="115" class="label-small">Client Interface</text>
  <rect x="120" y="123" width="16" height="12" class="handler-box"/>
  <text x="142" y="133" class="label-small">Handler Callback</text>

  <!-- TCP Connect -->
  <rect x="80" y="200" width="120" height="40" class="state" rx="6"/>
  <text x="140" y="225" text-anchor="middle" class="label-title">TCP Connect</text>

  <!-- Arrow: TCP -> Greeting -->
  <path d="M 200 220 L 280 220" class="arrow" marker-end="url(#arrowhead)"/>

  <!-- Greeting State -->
  <rect x="290" y="195" width="160" height="50" class="state" rx="6"/>
  <text x="370" y="217" text-anchor="middle" class="label-title">GREETING</text>
  <text x="370" y="233" text-anchor="middle" class="label-small">Waiting for 220</text>

  <!-- ServerGreeting handler box -->
  <rect x="290" y="250" width="160" height="45" class="handler-box"/>
  <text x="300" y="268" class="label-method">handleGreeting()</text>
  <text x="300" y="283" class="label-method">handleServiceUnavailable()</text>

  <!-- Arrow: Greeting -> HelloState -->
  <path d="M 450 220 L 530 220" class="arrow-success" marker-end="url(#arrowhead-success)"/>
  <text x="490" y="210" text-anchor="middle" class="label-small" fill="#276749">220</text>

  <!-- HelloState -->
  <rect x="540" y="195" width="150" height="50" class="state" rx="6"/>
  <text x="615" y="217" text-anchor="middle" class="label-title">HELLO</text>
  <text x="615" y="233" text-anchor="middle" class="label-small">ClientHelloState</text>

  <!-- ClientHelloState interface box -->
  <rect x="540" y="250" width="150" height="55" class="interface-box"/>
  <text x="550" y="268" class="label-method">ehlo(hostname, cb)</text>
  <text x="550" y="283" class="label-method">helo(hostname, cb)</text>
  <text x="550" y="298" class="label-method">quit()</text>

  <!-- Arrow: HelloState -> Session (EHLO success) -->
  <path d="M 615 305 L 615 360" class="arrow-success" marker-end="url(#arrowhead-success)"/>
  <text x="630" y="335" class="label-small" fill="#276749">250</text>

  <!-- ServerEhloReplyHandler box -->
  <rect x="700" y="280" width="180" height="60" class="handler-box"/>
  <text x="710" y="298" class="label-method">handleEhlo(starttls,</text>
  <text x="720" y="313" class="label-method">size, auth, pipe, session)</text>
  <text x="710" y="328" class="label-method">handleEhloNotSupported()</text>

  <!-- Arrow from handler to HelloState (502 fallback) -->
  <path d="M 700 310 L 690 310" class="arrow-fail"/>
  <text x="660" y="305" class="label-small" fill="#c53030">502</text>

  <!-- SESSION State -->
  <rect x="480" y="370" width="180" height="55" class="state-ready" rx="6"/>
  <text x="570" y="392" text-anchor="middle" class="label-title">SESSION</text>
  <text x="570" y="408" text-anchor="middle" class="label-small">ClientSession</text>

  <!-- ClientSession interface box -->
  <rect x="480" y="430" width="180" height="70" class="interface-box"/>
  <text x="490" y="448" class="label-method">mailFrom(addr, cb)</text>
  <text x="490" y="463" class="label-method">starttls(cb)</text>
  <text x="490" y="478" class="label-method">auth(mech, init, cb)</text>
  <text x="490" y="493" class="label-method">quit()</text>

  <!-- STARTTLS path -->
  <!-- Arrow: Session -> PostTls -->
  <path d="M 480 450 L 320 450 L 320 400" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="400" y="440" class="label-small">starttls()</text>

  <!-- PostTls State -->
  <rect x="240" y="340" width="160" height="50" class="state-tls" rx="6"/>
  <text x="320" y="362" text-anchor="middle" class="label-title">POST-TLS</text>
  <text x="320" y="378" text-anchor="middle" class="label-small">ClientPostTls</text>

  <!-- ClientPostTls interface box -->
  <rect x="240" y="280" width="160" height="40" class="interface-box"/>
  <text x="250" y="298" class="label-method">ehlo(hostname, cb)</text>
  <text x="250" y="313" class="label-method">quit()</text>

  <!-- Arrow: PostTls -> Session (via re-EHLO) -->
  <path d="M 400 365 L 480 390" class="arrow-success" marker-end="url(#arrowhead-success)"/>
  <text x="440" y="365" class="label-small" fill="#276749">re-EHLO</text>

  <!-- Arrow: Session -> Envelope (mailFrom) -->
  <path d="M 570 500 L 570 545" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="600" y="525" class="label-small">mailFrom()</text>

  <!-- ServerMailFromReplyHandler box -->
  <rect x="680" y="510" width="180" height="55" class="handler-box"/>
  <text x="690" y="528" class="label-method">handleMailFromOk(envelope)</text>
  <text x="690" y="543" class="label-method">handleTemporaryFailure()</text>
  <text x="690" y="558" class="label-method">handlePermanentFailure()</text>

  <!-- Envelope State -->
  <rect x="480" y="555" width="180" height="50" class="state" rx="6"/>
  <text x="570" y="577" text-anchor="middle" class="label-title">ENVELOPE</text>
  <text x="570" y="593" text-anchor="middle" class="label-small">ClientEnvelope</text>

  <!-- ClientEnvelope interface box -->
  <rect x="480" y="610" width="180" height="55" class="interface-box"/>
  <text x="490" y="628" class="label-method">rcptTo(addr, cb)</text>
  <text x="490" y="643" class="label-method">rset(cb)</text>
  <text x="490" y="658" class="label-method">quit()</text>

  <!-- Arrow: Envelope -> EnvelopeReady -->
  <path d="M 570 665 L 570 700" class="arrow-success" marker-end="url(#arrowhead-success)"/>
  <text x="590" y="685" class="label-small" fill="#276749">rcptTo() 250</text>

  <!-- ServerRcptToReplyHandler box -->
  <rect x="680" y="640" width="200" height="55" class="handler-box"/>
  <text x="690" y="658" class="label-method">handleRcptToOk(envelopeReady)</text>
  <text x="690" y="673" class="label-method">handleTemporaryFailure(state)</text>
  <text x="690" y="688" class="label-method">handleRecipientRejected(state)</text>

  <!-- EnvelopeReady State -->
  <rect x="480" y="710" width="180" height="50" class="state" rx="6"/>
  <text x="570" y="732" text-anchor="middle" class="label-title">ENVELOPE READY</text>
  <text x="570" y="748" text-anchor="middle" class="label-small">ClientEnvelopeReady</text>

  <!-- ClientEnvelopeReady interface box -->
  <rect x="480" y="765" width="180" height="70" class="interface-box"/>
  <text x="490" y="783" class="label-method">rcptTo(addr, cb)</text>
  <text x="490" y="798" class="label-method">data(cb)</text>
  <text x="490" y="813" class="label-method">rset(cb)</text>
  <text x="490" y="828" class="label-method">quit()</text>

  <!-- Loopback arrow for more rcptTo -->
  <path d="M 660 735 L 700 735 L 700 780 L 660 795" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="720" y="760" class="label-small">more rcptTo()</text>

  <!-- Arrow: EnvelopeReady -> Data -->
  <path d="M 480 790 L 350 790 L 350 760" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="410" y="780" class="label-small">data()</text>

  <!-- DATA State -->
  <rect x="260" y="700" width="180" height="50" class="state-data" rx="6"/>
  <text x="350" y="722" text-anchor="middle" class="label-title">DATA MODE</text>
  <text x="350" y="738" text-anchor="middle" class="label-small">ClientMessageData</text>

  <!-- ClientMessageData interface box -->
  <rect x="260" y="630" width="180" height="45" class="interface-box"/>
  <text x="270" y="648" class="label-method">write(content)</text>
  <text x="270" y="663" class="label-method">endMessage(cb)</text>

  <!-- ServerDataReplyHandler box -->
  <rect x="40" y="705" width="200" height="55" class="handler-box"/>
  <text x="50" y="723" class="label-method">handleReadyForData(data)</text>
  <text x="50" y="738" class="label-method">handleTemporaryFailure()</text>
  <text x="50" y="753" class="label-method">handlePermanentFailure()</text>

  <!-- Arrow: Data -> Session (message accepted) -->
  <path d="M 350 700 L 350 550 L 180 550 L 180 420 L 480 420" class="arrow-success" marker-end="url(#arrowhead-success)"/>
  <text x="250" y="540" class="label-small" fill="#276749">250 Accepted</text>

  <!-- ServerMessageReplyHandler box -->
  <rect x="40" y="580" width="200" height="55" class="handler-box"/>
  <text x="50" y="598" class="label-method">handleMessageAccepted(qid, s)</text>
  <text x="50" y="613" class="label-method">handleTemporaryFailure()</text>
  <text x="50" y="628" class="label-method">handlePermanentFailure()</text>

  <!-- RSET arrow back to Session -->
  <path d="M 260 810 L 180 810 L 180 480 L 480 460" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="195" y="650" class="label-small">rset() 250</text>

  <!-- CLOSED State -->
  <rect x="80" y="380" width="120" height="40" class="state-terminal" rx="6"/>
  <text x="140" y="405" text-anchor="middle" class="label-title">CLOSED</text>

  <!-- quit() arrows -->
  <path d="M 140 340 L 140 380" class="arrow-fail" marker-end="url(#arrowhead)"/>
  <text x="155" y="360" class="label-small" fill="#c53030">quit()</text>

  <!-- AUTH reference -->
  <rect x="890" y="430" width="180" height="60" class="state" rx="6" stroke-dasharray="4,2"/>
  <text x="980" y="455" text-anchor="middle" class="label-title">AUTH</text>
  <text x="980" y="472" text-anchor="middle" class="label-small">See smtp-client-auth.svg</text>
  
  <!-- Arrow: Session -> AUTH -->
  <path d="M 660 465 L 890 460" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="775" y="450" class="label-small">auth()</text>
  
  <!-- Arrow: AUTH -> Session -->
  <path d="M 890 475 L 660 475" class="arrow-success" marker-end="url(#arrowhead-success)"/>
  <text x="775" y="490" class="label-small" fill="#276749">235 Success</text>

</svg>

