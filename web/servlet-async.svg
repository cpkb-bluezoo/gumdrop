<?xml version="1.0" encoding="UTF-8"?>
<!--
  Gumdrop Servlet Async Flow Diagram
  Copyright (C) 2025 Chris Burdess
-->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600" width="800" height="600">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2d5a3d"/>
    </marker>
    <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3d5a8a"/>
    </marker>
    <marker id="arrowhead-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#8a5a3d"/>
    </marker>
    <linearGradient id="boxGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#f8f8f0"/>
      <stop offset="100%" style="stop-color:#e8e8e0"/>
    </linearGradient>
    <linearGradient id="threadGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#e8f0e8"/>
      <stop offset="100%" style="stop-color:#d0e0d0"/>
    </linearGradient>
    <linearGradient id="asyncGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#e8e8f0"/>
      <stop offset="100%" style="stop-color:#d0d0e8"/>
    </linearGradient>
  </defs>
  
  <!-- Background -->
  <rect width="800" height="600" fill="#fdfdf8"/>
  
  <!-- Title -->
  <text x="400" y="30" font-family="Georgia, serif" font-size="18" fill="#2d5a3d" text-anchor="middle" font-weight="bold">Async Servlet Processing Flow</text>
  
  <!-- Phase 1: Initial Request -->
  <rect x="20" y="50" width="230" height="200" rx="8" fill="url(#threadGradient)" stroke="#4a7a5a" stroke-width="2"/>
  <text x="135" y="75" font-family="Georgia, serif" font-size="14" fill="#2d5a3d" text-anchor="middle" font-weight="bold">Phase 1: Initial Request</text>
  
  <!-- SelectorLoop box -->
  <rect x="35" y="90" width="200" height="40" rx="4" fill="url(#boxGradient)" stroke="#5a8a6a" stroke-width="1"/>
  <text x="135" y="115" font-family="Consolas, monospace" font-size="12" fill="#3a3a3a" text-anchor="middle">SelectorLoop (I/O)</text>
  
  <!-- Arrow down -->
  <line x1="135" y1="130" x2="135" y2="150" stroke="#2d5a3d" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="145" y="145" font-family="Georgia, serif" font-size="10" fill="#5a5a5a">pipe</text>
  
  <!-- Worker Thread box -->
  <rect x="35" y="155" width="200" height="40" rx="4" fill="url(#boxGradient)" stroke="#5a8a6a" stroke-width="1"/>
  <text x="135" y="180" font-family="Consolas, monospace" font-size="12" fill="#3a3a3a" text-anchor="middle">Servlet Worker Thread</text>
  
  <!-- Servlet calls startAsync -->
  <rect x="35" y="205" width="200" height="35" rx="4" fill="#fff8e0" stroke="#aa9a50" stroke-width="1"/>
  <text x="135" y="227" font-family="Consolas, monospace" font-size="11" fill="#5a4a20" text-anchor="middle">request.startAsync()</text>
  
  <!-- Phase 2: Async Processing -->
  <rect x="280" y="50" width="240" height="250" rx="8" fill="url(#asyncGradient)" stroke="#4a5a8a" stroke-width="2"/>
  <text x="400" y="75" font-family="Georgia, serif" font-size="14" fill="#3d4a6a" text-anchor="middle" font-weight="bold">Phase 2: Async Processing</text>
  
  <!-- Worker thread released -->
  <rect x="295" y="90" width="210" height="35" rx="4" fill="#e8ffe8" stroke="#5a8a5a" stroke-width="1"/>
  <text x="400" y="112" font-family="Georgia, serif" font-size="11" fill="#3a5a3a" text-anchor="middle">Worker thread released ✓</text>
  
  <!-- Timeout scheduled -->
  <rect x="295" y="135" width="210" height="35" rx="4" fill="url(#boxGradient)" stroke="#5a8a6a" stroke-width="1"/>
  <text x="400" y="157" font-family="Consolas, monospace" font-size="11" fill="#3a3a3a" text-anchor="middle">Timeout scheduled</text>
  
  <!-- Application logic -->
  <rect x="295" y="180" width="210" height="55" rx="4" fill="#f0f0ff" stroke="#6a6a8a" stroke-width="1"/>
  <text x="400" y="200" font-family="Georgia, serif" font-size="11" fill="#4a4a6a" text-anchor="middle">Application performs</text>
  <text x="400" y="215" font-family="Georgia, serif" font-size="11" fill="#4a4a6a" text-anchor="middle">async work (DB, HTTP, etc.)</text>
  <text x="400" y="230" font-family="Consolas, monospace" font-size="10" fill="#6a6a8a" text-anchor="middle">ctx.start(runnable)</text>
  
  <!-- ASYNC_EXECUTOR box -->
  <rect x="295" y="245" width="210" height="45" rx="4" fill="url(#boxGradient)" stroke="#5a8a6a" stroke-width="1"/>
  <text x="400" y="265" font-family="Consolas, monospace" font-size="11" fill="#3a3a3a" text-anchor="middle">ASYNC_EXECUTOR</text>
  <text x="400" y="280" font-family="Georgia, serif" font-size="10" fill="#5a5a5a" text-anchor="middle">(container thread pool)</text>
  
  <!-- Arrow from Phase 1 to Phase 2 -->
  <line x1="250" y1="125" x2="280" y2="107" stroke="#3d5a8a" stroke-width="2" marker-end="url(#arrowhead-blue)"/>
  
  <!-- Phase 3: Completion -->
  <rect x="550" y="50" width="230" height="250" rx="8" fill="url(#threadGradient)" stroke="#8a5a3d" stroke-width="2"/>
  <text x="665" y="75" font-family="Georgia, serif" font-size="14" fill="#6a4a2d" text-anchor="middle" font-weight="bold">Phase 3: Completion</text>
  
  <!-- complete() or dispatch() -->
  <rect x="565" y="95" width="200" height="45" rx="4" fill="#fff8e0" stroke="#aa9a50" stroke-width="1"/>
  <text x="665" y="115" font-family="Consolas, monospace" font-size="11" fill="#5a4a20" text-anchor="middle">asyncContext.complete()</text>
  <text x="665" y="130" font-family="Georgia, serif" font-size="10" fill="#7a6a40" text-anchor="middle">or dispatch()</text>
  
  <!-- Flush response -->
  <rect x="565" y="150" width="200" height="35" rx="4" fill="url(#boxGradient)" stroke="#5a8a6a" stroke-width="1"/>
  <text x="665" y="172" font-family="Consolas, monospace" font-size="11" fill="#3a3a3a" text-anchor="middle">response.flush()</text>
  
  <!-- Notify listeners -->
  <rect x="565" y="195" width="200" height="35" rx="4" fill="url(#boxGradient)" stroke="#5a8a6a" stroke-width="1"/>
  <text x="665" y="217" font-family="Consolas, monospace" font-size="11" fill="#3a3a3a" text-anchor="middle">listener.onComplete()</text>
  
  <!-- End stream -->
  <rect x="565" y="240" width="200" height="35" rx="4" fill="#e8ffe8" stroke="#5a8a5a" stroke-width="1"/>
  <text x="665" y="262" font-family="Georgia, serif" font-size="11" fill="#3a5a3a" text-anchor="middle">Stream completed ✓</text>
  
  <!-- Arrow from Phase 2 to Phase 3 -->
  <line x1="520" y1="220" x2="550" y2="117" stroke="#8a5a3d" stroke-width="2" marker-end="url(#arrowhead-orange)"/>
  
  <!-- Non-blocking I/O section -->
  <rect x="20" y="320" width="360" height="150" rx="8" fill="#f8f0f8" stroke="#8a5a8a" stroke-width="2"/>
  <text x="200" y="345" font-family="Georgia, serif" font-size="14" fill="#6a4a6a" text-anchor="middle" font-weight="bold">Non-Blocking I/O (Optional)</text>
  
  <!-- ReadListener -->
  <rect x="35" y="360" width="160" height="45" rx="4" fill="url(#boxGradient)" stroke="#8a5a8a" stroke-width="1"/>
  <text x="115" y="380" font-family="Consolas, monospace" font-size="11" fill="#5a3a5a" text-anchor="middle">ReadListener</text>
  <text x="115" y="395" font-family="Georgia, serif" font-size="9" fill="#7a6a7a" text-anchor="middle">onDataAvailable()</text>
  
  <!-- WriteListener -->
  <rect x="205" y="360" width="160" height="45" rx="4" fill="url(#boxGradient)" stroke="#8a5a8a" stroke-width="1"/>
  <text x="285" y="380" font-family="Consolas, monospace" font-size="11" fill="#5a3a5a" text-anchor="middle">WriteListener</text>
  <text x="285" y="395" font-family="Georgia, serif" font-size="9" fill="#7a6a7a" text-anchor="middle">onWritePossible()</text>
  
  <!-- Pipe integration note -->
  <rect x="35" y="415" width="330" height="45" rx="4" fill="#fff8f8" stroke="#aa8a8a" stroke-width="1"/>
  <text x="200" y="435" font-family="Georgia, serif" font-size="10" fill="#6a4a4a" text-anchor="middle">Callbacks triggered by SelectorLoop events</text>
  <text x="200" y="450" font-family="Georgia, serif" font-size="10" fill="#6a4a4a" text-anchor="middle">via pipe data arrival or buffer availability</text>
  
  <!-- Error handling section -->
  <rect x="420" y="320" width="360" height="150" rx="8" fill="#fff0f0" stroke="#8a3a3a" stroke-width="2"/>
  <text x="600" y="345" font-family="Georgia, serif" font-size="14" fill="#6a2a2a" text-anchor="middle" font-weight="bold">Error &amp; Timeout Handling</text>
  
  <!-- Timeout -->
  <rect x="435" y="360" width="155" height="45" rx="4" fill="url(#boxGradient)" stroke="#8a5a5a" stroke-width="1"/>
  <text x="512" y="380" font-family="Consolas, monospace" font-size="11" fill="#5a3a3a" text-anchor="middle">Timeout</text>
  <text x="512" y="395" font-family="Georgia, serif" font-size="9" fill="#7a6a6a" text-anchor="middle">listener.onTimeout()</text>
  
  <!-- Connection close -->
  <rect x="600" y="360" width="165" height="45" rx="4" fill="url(#boxGradient)" stroke="#8a5a5a" stroke-width="1"/>
  <text x="682" y="380" font-family="Consolas, monospace" font-size="11" fill="#5a3a3a" text-anchor="middle">Connection Close</text>
  <text x="682" y="395" font-family="Georgia, serif" font-size="9" fill="#7a6a6a" text-anchor="middle">listener.onError()</text>
  
  <!-- Telemetry integration note -->
  <rect x="435" y="415" width="330" height="45" rx="4" fill="#f8f0f0" stroke="#aa8a8a" stroke-width="1"/>
  <text x="600" y="435" font-family="Georgia, serif" font-size="10" fill="#6a4a4a" text-anchor="middle">Errors recorded in OpenTelemetry spans</text>
  <text x="600" y="450" font-family="Georgia, serif" font-size="10" fill="#6a4a4a" text-anchor="middle">with ErrorCategory classification</text>
  
  <!-- Legend -->
  <rect x="20" y="490" width="760" height="90" rx="8" fill="#f4f4f0" stroke="#aaa" stroke-width="1"/>
  <text x="400" y="515" font-family="Georgia, serif" font-size="12" fill="#4a4a4a" text-anchor="middle" font-weight="bold">Architecture Advantages</text>
  
  <!-- Legend items -->
  <circle cx="50" cy="540" r="6" fill="#5a8a5a"/>
  <text x="65" y="544" font-family="Georgia, serif" font-size="10" fill="#3a3a3a">I/O layer: Always non-blocking (NIO SelectorLoop)</text>
  
  <circle cx="50" cy="560" r="6" fill="#5a5a8a"/>
  <text x="65" y="564" font-family="Georgia, serif" font-size="10" fill="#3a3a3a">Worker thread: Released during async, reusable for other requests</text>
  
  <circle cx="420" cy="540" r="6" fill="#8a5a5a"/>
  <text x="435" y="544" font-family="Georgia, serif" font-size="10" fill="#3a3a3a">Thread pool: ASYNC_EXECUTOR for start() and dispatch()</text>
  
  <circle cx="420" cy="560" r="6" fill="#8a8a5a"/>
  <text x="435" y="564" font-family="Georgia, serif" font-size="10" fill="#3a3a3a">Timeout: Configurable with automatic error handling</text>
</svg>

